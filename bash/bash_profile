#!/usr/bin/env bash

# NOTE: load `~/.bashrc` first which contains personal sensitive setting
[[ -f "$HOME/.bashrc" ]] && source "$HOME/.bashrc"

##############################################################
####                                                     #####
####                QUOTE                                #####
####                                                     #####
##############################################################
# refer, https://github.com/ruanyf/fortunes
function run_fortune() {
  if [[ ! -x "$(command -v fortune)" ]]; then
    return
  fi

  # echo "=============== Quote Of The Day ==============="
  echo

  # if [[ -x "$(command -v lolcat)" ]]; then
  #   fortune | lolcat
  # else
  #   fortune
  # fi

  fortune

  # echo "================================================"
  printf "\n"
}

run_fortune

##############################################################
####                                                     #####
####                BASIC                                #####
####                                                     #####
##############################################################

function setup_homebrew() {
  # https://juejin.im/post/5c738bacf265da2deb6aaf97
  # https://www.zhihu.com/question/31360766

  # use mirror for homebrew
  # https://lug.ustc.edu.cn/wiki/mirrors/help/brew.git
  if [[ -z "${DISABLE_BREW_MIRROR}" ]]; then
    export HOMEBREW_BOTTLE_DOMAIN="https://mirrors.ustc.edu.cn/homebrew-bottles"

    (cd "$(brew --repo)" &&
      git remote set-url origin https://mirrors.ustc.edu.cn/brew.git)

    (cd "$(brew --repo)/Library/Taps/homebrew/homebrew-core" &&
      git remote set-url origin https://mirrors.ustc.edu.cn/homebrew-core.git)
  fi

  # Homebrew's sbin
  export PATH="/usr/local/sbin:$PATH"
}

function setup_locale() {
  # locale
  export LC_ALL=en_US.UTF-8
  export LANG=en_US.UTF-8
}

function setup_path() {
  export EDITOR=nvim
  export FIREFOX_HOME="/Applications/Firefox.app/Contents/MacOS"
  export PATH="/usr/local/bin:$PATH:$FIREFOX_HOME"
}

function setup_git() {
  # git & hub
  eval "$(hub alias -s)"
  alias git='LANG=en_US git'
}

function setup_shortcuts() {
  # shortcuts for accessing folder
  alias sdl='cd ~/Downloads'
  alias sdc='cd ~/Documents'

  # workshop and github
  alias ghh='cd $HOME/workshop/github'
  alias sgh='cd $HOME/workshop/github/shohi'
  alias sws='cd $HOME/workshop'

  # vim/nvim pluggings
  alias nvp='cd $HOME/.vim/plugged'

  alias remote='[[ -d $HOME/workshop/remote ]] && cd $HOME/workshop/remote'

  # useful env
  local hostip
  hostip=$(ipconfig getifaddr en0)
  export HOSTIP=${hostip}
}

setup_homebrew
setup_locale
setup_path
setup_git
setup_shortcuts

# SSH
# Dynamic Port Forwarding
# alias aws_proxy='ssh -qTfnN -D [local_ip]:[local_port] [via_user]@[via_ip]'
#
# Port Forwarding
# ssh -fN -L [local_port]:[remote_ip]:[remote_port] [via_user]:[via_ip]
# ssh -fN -L 7002:172.31.6.103:6443 ${SSH_VIA}

function set_openssl() {
  # need openssl installed by homebrew, e.g.
  # "brew install opensll"

  export PATH="/usr/local/opt/openssl@1.1/bin:$PATH"
  export LDFLAGS="-L/usr/local/opt/openssl@1.1/lib"
  export CPPFLAGS="-I/usr/local/opt/openssl@1.1/include"
  export PKG_CONFIG_PATH="/usr/local/opt/openssl@1.1/lib/pkgconfig"
}

set_openssl

function set_aws_proxy() {
  if [[ -n "${SSH_VIA}" ]]; then
    alias aws_proxy='ssh -qTfnN -D 127.0.0.1:62222 ${SSH_VIA}'
  fi
}

set_aws_proxy

# autojump
[[ -f /usr/local/etc/profile.d/autojump.sh ]] && . /usr/local/etc/profile.d/autojump.sh

# homebrew
# export HOMEBREW_BOTTLE_DOMAIN=https://mirrors.tuna.tsinghua.edu.cn/homebrew-bottles

##############################################################
####                                                     #####
####                Golang                               #####
####                                                     #####
##############################################################
# use following accessible `GO_BINARY_BASE_URL`.
export GO_BINARY_BASE_URL="https://dl.google.com/go"

# install gvm
function setup_gvm() {
  mkdir -p "$HOME"/.github/moovweb && pushd -q "$_" || return

  local repo="gvm"

  # install gvm
  if [[ ! -d "$repo" ]]; then
    # git clone https://github.com/moovweb/$repo.git
    git clone https://github.com/shohi/$repo.git
    SRC_REPO="https://github.com/shohi/$repo.git" source gvm/binscripts/gvm-installer
  fi

  # activate it
  source "$HOME"/.gvm/scripts/gvm

  popd -q || return
}

# update gvm
function update_gvm() {
  mkdir -p "$HOME"/.github/moovweb && pushd -q "$_" || return

  local repo="gvm"

  # update gvm
  if [[ ! -d "$repo" ]]; then
    setup_gvm
  else
    pushd -q "$PWD/$repo" || return

    # update repo and activate it
    git pull --all
    source "$HOME"/.gvm/scripts/gvm

    popd -q || return
  fi

  popd -q || return
}

setup_gvm

# setup gopath and aliases
function setup_golang() {
  export GOROOT=${GOROOT:-/usr/local/opt/go/libexec}
  export DEFAULT_GOPATH=${GOPATH:-$HOME/workshop/go}
  export GOBIN=$DEFAULT_GOPATH/bin
  mkdir -p "$DEFAULT_GOPATH"/{src,bin,pkg}

  if [[ -z "${WORK_GOPATH}" ]]; then
    export GOPATH=$DEFAULT_GOPATH
    export PATH=$PATH:$GOROOT/bin:$GOBIN
  else
    export GOPATH=$DEFAULT_GOPATH:$WORK_GOPATH
    export PATH=$PATH:$GOROOT/bin:$GOBIN:$WORK_GOPATH/bin
  fi

  alias gotest='go test -v -count=1'

  alias gop='cd $DEFAULT_GOPATH'
  alias gws='cd $DEFAULT_GOPATH/src'
  alias gwp='cd $DEFAULT_GOPATH/pkg'
  alias gwb='cd $DEFAULT_GOPATH/bin'
  alias ggh='cd $DEFAULT_GOPATH/src/github.com'
  alias gosc='cd $HOME/workshop/github/golang/go'
  alias gosrc='cd $GOROOT'

  # proxy
  # export GOPROXY=https://goproxy.io
  if [[ -z "${DISABLE_GOPROXY}" ]]; then
    # refer, https://goproxy.io/
    export GO111MODULE=on
    export GOPROXY=https://goproxy.io
    # export GOPROXY=https://athens.azurefd.net
    # export GOPROXY=https://mirrors.aliyun.com/goproxy/
  fi
}

setup_golang

##############################################################
####                                                     #####
####                K8s                                  #####
####                                                     #####
##############################################################
function set_kubectl_alias() {
  mkdir -p "$HOME"/.github/ahmetb && pushd -q "$_" || return

  # download kubectl-alias
  if [[ ! -d "kubectl-alias" ]]; then
    git clone https://github.com/ahmetb/kubectl-alias.git
  fi

  source kubectl-alias/.kubectl_aliases

  alias kgnoa='kubectl get node | grep -v "NotReady"'
  alias kgnoasl='kubectl get node --show-labels | grep -v "NotReady"'

  popd -q || return
}

# update kubectl alias
function update_kubectl_alias() {
  mkdir -p "$HOME"/.github/ahmetb && pushd -q "$_" || return

  local repo="kubectl-alias"

  # install kubectl-alias
  if [[ -d "$repo" ]]; then
    pushd -q "$PWD/$repo" || return
    git pull --all
    popd -q || return
  fi

  set_kubectl_alias

  popd -q || return
}

function set_kubectx() {
  mkdir -p "$HOME"/.github/ahmetb && pushd -q "$_" || return

  # download kubectx
  if [[ ! -d "kubectx" ]]; then
    git clone https://github.com/ahmetb/kubectx.git
  fi

  # add soft link to /usr/local/bin
  chmod +x "$PWD"/kubectx/kubectx
  chmod +x "$PWD"/kubectx/kubens

  ln -s -f "$PWD"/kubectx/kubectx /usr/local/bin/kubectx
  ln -s -f "$PWD"/kubectx/kubens /usr/local/bin/kubens

  # TODO: link auto completion scripts
  popd -q || return
}

function update_kubectx() {
  mkdir -p "$HOME"/.github/ahmetb && pushd -q "$_" || return

  local repo="kubectx"

  # install kubectx
  if [[ -d "$repo" ]]; then
    pushd -q "$PWD/$repo" || return
    git pull --all
    popd -q || return
  fi

  set_kubectx
  popd -q || return
}

set_kubectl_alias
set_kubectx

# print kubectl full command before running
function kubectl() {
  echo "+ kubectl $*"
  command kubectl "$@"
}

##############################################################
####                                                     #####
####                Java                                 #####
####                                                     #####
##############################################################

# setup env for java
function setup_java() {
  local jh
  jh="$(/usr/libexec/java_home)"

  export JAVA_HOME=${jh}
  export GRADLE_HOME=/usr/local/opt/gradle/libexec
  export MAVEN_OPTS="-Dmaven.wagon.http.ssl.insecure=true -Dmaven.wagon.http.ssl.allowall=true"
  export M2_HOME=/usr/local/Cellar/maven/3.6.0/libexec

  export JAVA_HOME
  export PATH="$PATH:$GRADLE_HOME/bin"
}

setup_java

##############################################################
####                                                     #####
####                Python                               #####
####                                                     #####
##############################################################

function init_pyenv() {
  # install python version manager
  if [[ ! -x "$(command -v pyenv)" ]]; then
    echo "please install python version manager firstly - pyenv."
    return
  else
    # set MIRROR for python itself
    # export PYTHON_BUILD_MIRROR_URL="https://npm.taobao.org/mirrors/python"
    # NOTE: As the post points out, current pyenv can't work with the configure properly.
    # The workaround is to download the tar manually and set `PYTHON_BUILD_CACHE_PATH` to
    # the download directory, e.g
    # mkdir -p ~/.pyenv/cache
    # cd ~/.pyenv/cache && wget "https://npm.taobao.org/mirrors/python/3.8.0/Python-3.8.0.tar.xz"
    # PYTHON_BUILD_CACHE_PATH="$PWD" pyenv install 3.8.0
    mkdir -p "$HOME/.pyenv/cache"
    export PYTHON_BUILD_CACHE_PATH="$HOME/.pyenv/cache"

    # pyenv init is slow
    # issue, https://github.com/pyenv/pyenv/issues/784
    eval "$(pyenv init - zsh --no-rehash)"
  fi
}

function check_pip_version() {
  local pver
  pver=$(pip3 --version | awk -F '[ .]' '{print $2}')
  if [ "$pver" -lt 10 ]; then
    pip3 install pip -U
  fi
}

function setup_python() {
  # NOTE: as `$(pyenv init - )` is slow, leave it to load
  # manually.

  # TODO: find out a way to lazy-load pyenv
  init_pyenv

  # use tsinghua mirror
  # https://mirror.tuna.tsinghua.edu.cn/help/pypi/
  # TODO: check geolocation
  if [[ -n "${DISABLE_PYTHON_MIRROR}" ]]; then
    return
  fi

  if [[ -x "$(command -v pip3)" ]]; then
    local mirror_url="https://pypi.tuna.tsinghua.edu.cn/simple"

    # NOTE: pip config file `$HOME/.config/pip` and the `global.index-url`
    # item may be not exist. check exit code `$?`.
    local cur_url
    cur_url="$(pip3 config get global.index-url)"
    if [ $? -ne 0 ] || [ "${cur_url}" != "${mirror_url}" ]; then
      check_pip_version

      pip3 config set global.index-url "${mirror_url}"
    fi
  else
    echo "please install python first using pyevn."
    return
  fi

}

function setup_python_alias() {
  if [[ -x "$(command -v python3)" ]]; then
    if ! pip3 list | grep "ipython" >/dev/null; then
      pip3 install -U ipython
    fi

    alias ipy="python3 -c 'import IPython; IPython.terminal.ipapp.launch_new_instance()'"
  fi
}

setup_python
setup_python_alias

##############################################################
####                                                     #####
####                Ruby                                 #####
####                                                     #####
##############################################################
function setup_ruby() {
  # load RVM into a shell session *as a function*
  [[ -s "$HOME/.rvm/scripts/rvm" ]] && source "$HOME/.rvm/scripts/rvm"

  # add RVM to PATH for scripting. Make sure this is the last PATH variable change.
  export PATH="$PATH:$HOME/.rvm/bin"

  # set RubyGems Source
  # check gem sources - `gem sources -l`, and replace the source.
  # gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/
  if [[ -x "$(command -v gem)" ]]; then
    local gem_source="https://gems.ruby-china.com/"
    if ! gem sources -l | grep -q ${gem_source}; then
      gem sources --add "${gem_source}" --remove https://rubygems.org/
    fi
  fi
}

setup_ruby

##############################################################
####                                                     #####
####                Rust                                 #####
####                                                     #####
##############################################################
# Default CARGO_HOME - `$HOME/.cargo`
# - https://doc.rust-lang.org/cargo/guide/cargo-home.html
#
# Default RUST_HOME - `$HOME/.rustup`
# - https://github.com/rust-lang/rustup#environment-variables
function setup_rust() {
  mkdir -p "$HOME"/.cargo
  export CARGO_HOME="$HOME"/.cargo

  # rustup toolchain mirror
  # https://mirrors.ustc.edu.cn/help/rust-static.html
  if [[ -z "${DISABLE_RUSTUP_MIRROR}" ]]; then
    export RUSTUP_DIST_SERVER=https://mirrors.ustc.edu.cn/rust-static
    export RUSTUP_UPDATE_ROOT=https://mirrors.ustc.edu.cn/rust-static/rustup
  fi

  # crates.io mirror
  # https://lug.ustc.edu.cn/wiki/mirrors/help/rust-crates
  if [[ -z "${DISABLE_CRATES_IO_MIRROR}" ]]; then
    if [[ ! -f "${CARGO_HOME}/use_ustc_mirror" ]]; then
      touch "${CARGO_HOME}/use_ustc_mirror"

      local conf
      conf=$(
        cat <<HEREDOC
[source.crates-io]
registry = "https://github.com/rust-lang/crates.io-index"
replace-with = 'ustc'
[source.ustc]
registry = 'git://mirrors.ustc.edu.cn/crates.io-index'
HEREDOC
      )

      echo "${conf}" >"${CARGO_HOME}"/config
    fi
  fi

  export PATH="${CARGO_HOME}/bin:$PATH:$HOME/workshop/github/brendangregg/FlameGraph"
}

setup_rust

##############################################################
####                                                     #####
####                Flutter                              #####
####                                                     #####
##############################################################
function setup_flutter() {
  export FLUTTER_HOME=$HOME/workshop/flutter
  export PUB_HOSTED_URL=https://pub.flutter-io.cn
  export FLUTTER_STORAGE_BASE_URL=https://storage.flutter-io.cn

  export PATH="$PATH:$FLUTTER_HOME/bin"
}

setup_flutter

##############################################################
####                                                     #####
####                Nim                                  #####
####                                                     #####
##############################################################
function setup_nim() {
  export PATH=$HOME/.nimble/bin:$PATH
}

setup_nim

##############################################################
####                                                     #####
####                Emacs                                #####
####                                                     #####
##############################################################
# refer, https://emacsformacosx.com/tips
function setup_emacs() {
  if [[ ! -x "/Applications/Emacs.app/Contents/MacOS/Emacs" ]]; then
    echo "plz install Emacs firstly, e.g. $(brew cask install emacs)."
  else
    alias emacs="/Applications/Emacs.app/Contents/MacOS/Emacs -nw"
    alias emacsclient="/Applications/Emacs.app/Contents/MacOS/bin/emacsclient"
  fi
}

setup_emacs

##############################################################
####                                                     #####
####                ctags                                #####
####                                                     #####
##############################################################
function setup_ctags() {
  # refer, https://gist.github.com/nazgob/1570678
  # replace macOS builtin one with `brew` one
  # first install - `brew install ctags`
  # TODO: install ctags if not exist
  alias ctags='$(brew --prefix)/bin/ctags'

  # ctags setup for golang
  # require `gotags` installed first - https://github.com/jstemmer/gotags
  # TODO: check whether `gotags` is installed in $GOBIN

}

setup_ctags

##############################################################
####                                                     #####
####                bash                                 #####
####                                                     #####
##############################################################
# refer, https://stackoverflow.com/questions/370047/what-is-the-most-elegant-way-to-remove-a-path-from-the-path-variable-in-bash
function path_append() {
  path_remove "$1"
  export PATH="$PATH:$1"
}

function path_prepend() {
  path_remove "$1"
  export PATH="$1:$PATH"
}

function path_remove() {
  local np
  np=$(echo -n "$PATH" | awk -v RS=: -v ORS=: '$0 != "'"$1"'"' | sed 's/:$//')
  export PATH=$np
}

# load customized scripts from github repo.
function load_customized_scripts() {
  mkdir -p ~/.github/shohi && pushd -q "$_" || return

  local repo="blond"

  # download "blond"
  if [[ ! -d "blond" ]]; then
    git clone https://github.com/shohi/blond.git
  fi

  # use main entry
  pushd -q "${repo}" || return
  source "main.sh"
  popd -q || return

  # restore previous working directory where the function is called.
  popd -q || return
}

# update customized scripts
function update_customized_scripts() {
  mkdir -p ~/.github/shohi && pushd -q "$_" || return

  local repo="blond"

  # install customized scripts
  if [[ ! -d "${repo}" ]]; then
    load_customized_scripts
  else
    pushd -q "${PWD}/${repo}" || return

    git pull --all
    source "main.sh"

    popd -q || return
  fi

  popd -q || return
}

load_customized_scripts

# -*- vim: set ft=bash: -*-
